<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f0f2f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { display: flex; align-items: center; margin-bottom: 30px; }
        .back-link { text-decoration: none; color: #34495e; font-weight: bold; margin-right: 15px; font-size: 16px; }
        .back-link:hover { color: #0984e3; }
        h2 { margin: 0; color: #2c3e50; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        input:focus { border-color: #3498db; outline: none; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }
        .msg { text-align: center; margin-top: 15px; font-size: 14px; display: none; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">‚Üê Dashboard</a>
            <h2>User Profile</h2>
        </div>
        
        <div id="profile-form">
            <div class="form-group" style="text-align: center;">
                <img id="avatar-preview" src="" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;">
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarChange(this)">
                <button onclick="document.getElementById('avatar-upload').click()" style="width: auto; padding: 5px 15px; font-size: 14px; background-color: #95a5a6;">Change Photo</button>
            </div>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="name" placeholder="Your Name">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" readonly style="background-color: #f8f9fa; color: #7f8c8d; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" placeholder="Phone Number">
            </div>
            <div class="form-group">
                <label>New Password (leave blank to keep current)</label>
                <input type="password" id="password" placeholder="********">
            </div>
            <button onclick="saveProfile()">Save Changes</button>
            <button onclick="logout()" style="background-color: #e74c3c; margin-top: 15px;">Logout</button>
            <div id="msg" class="msg"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentProfilePic = '';
        
        window.onload = async () => {
            const storedUser = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!storedUser) {
                window.location.href = '/'; 
                return;
            }
            const user = JSON.parse(storedUser);
            document.getElementById('email').value = user.email;
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const res = await fetch(`${API_URL}/user/profile`, {
                    method: 'GET',
                    headers: headers
                });
                
                if(res.ok) {
                    const data = await res.json();
                    const profileData = data.data || data;
                    document.getElementById('name').value = profileData.name || '';
                    document.getElementById('phone').value = profileData.phone || '';
                    if (profileData.profilePicture) {
                        document.getElementById('avatar-preview').src = profileData.profilePicture;
                        currentProfilePic = profileData.profilePicture;
                    } else {
                        // Default avatar
                        const displayName = profileData.name || user.email;
                        document.getElementById('avatar-preview').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random&color=fff&size=128`;
                    }
                }
            } catch(e) { console.error("Failed to load profile", e); }
        };

        function handleAvatarChange(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 500000) { // 500KB limit
                    alert("Image too large. Please select an image under 500KB.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatar-preview').src = e.target.result;
                    currentProfilePic = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveProfile() {
            const email = document.getElementById('email').value;
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('msg');
            const token = localStorage.getItem('token');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const res = await fetch(`${API_URL}/user/profile`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ email, name, phone, password, profilePicture: currentProfilePic })
                });
                
                const data = await res.json();
                
                msg.style.display = 'block';
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.innerText = 'Profile updated successfully!';
                    // Update local storage
                    const storedUser = JSON.parse(localStorage.getItem('user'));
                    storedUser.name = data.user.name;
                    storedUser.profilePicture = data.user.profilePicture;
                    localStorage.setItem('user', JSON.stringify(storedUser));
                    // Clear password field
                    document.getElementById('password').value = '';
                } else {
                    msg.className = 'msg error';
                    msg.innerText = data.error || data.message || 'Update failed';
                }
            } catch (err) {
                msg.style.display = 'block';
                msg.className = 'msg error';
                msg.innerText = 'Network error. Check console.';
                console.error(err);
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
</body>
</html>